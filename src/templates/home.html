<!-- í™ˆ í˜ì´ì§€ -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ìŠ¤ë§ˆíŠ¸ ìˆ˜ë©´ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.2/mqttws31.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js"></script>      
    <script src="./static/realTimeChart.js" type="text/javascript"></script>      
    <script src="./static/mqttIO.js" type="text/javascript"></script>
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="/" class="logo">ğŸŒ™ ìŠ¤ë§ˆíŠ¸ ìˆ˜ë©´ ê´€ë¦¬</a>
            <nav class="nav-menu">
                <a href="/" class="active">í™ˆ</a>
                <a href="/dashboard">ëŒ€ì‹œë³´ë“œ</a>
                <a href="/settings">ì„¤ì •</a>
                <a href="/help">ë„ì›€ë§</a>
            </nav>
        </div>
    </header>
    
    <main class="container dashboard-grid">
        <div class="first-row">
            <!-- í˜„ì¬ ìƒíƒœ íŒ¨ë„ -->
            <div class="status-panel">
                <h2>í˜„ì¬ ìƒíƒœ</h2>
                <div class="status-grid">
                    <div class="status-item">
                        <h3>ì˜¨ë„</h3>
                        <p id="temperature">--Â°C</p>
                    </div>
                    <div class="status-item">
                        <h3>ìŠµë„</h3>
                        <p id="humidity">--%</p>
                    </div>
                    <div class="status-item">
                        <h3>ì¡°ë„</h3>
                        <p id="light">--lux</p>
                    </div>
                </div>
                <div class="alert alert-warning">
                    <p>ğŸ’¡ í˜„ì¬ ì˜¨ë„ê°€ ì ì • ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤. 19Â°Cë¡œ ì„¤ì •í•˜ëŠ” ê²ƒì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
                </div>
            </div>
            
            <!-- ìˆ˜ë©´ ëª¨ë“œ ì œì–´ -->
            <div class="card">
                <h2>ìˆ˜ë©´ ëª¨ë“œ ì œì–´</h2>
                <button id="sleepModeBtn" class="btn btn-primary btn-large" onclick="toggleSleepMode()">
                    ìˆ˜ë©´ ëª¨ë“œ í™œì„±í™”
                </button>
                <div class="sleep-mode-message">
                    <p>ìˆ˜ë©´ í™˜ê²½ì„ ëª¨ë‹ˆí„°ë§ ì¤‘ì…ë‹ˆë‹¤.</p>
                    <div class="sleep-timer" id="sleepTimer">00:00:00</div>
                </div>
                <div class="wake-up-settings">
                    <div class="time-setting">
                        <label>ê¸°ìƒ ì‹œê°„</label>
                        <input type="time" id="wakeUpTime">
                    </div>
                    <div class="alarm-setting">
                        <label>ì•ŒëŒ ì†Œë¦¬</label>
                        <select id="alarmSound">
                            <option value="christmas">í¬ë¦¬ìŠ¤ë§ˆìŠ¤ ë©œë¡œë””</option>
                            <option value="soft_calm">ì”ì”í•œ ìŒì•…</option>
                            <option value="summer_morning">ìƒì¾Œí•œ ì•„ì¹¨</option>
                        </select>
                    </div>
                    <button id="saveAlarmBtn" class="btn btn-primary" onclick="saveAlarmSettings()">
                        ì•ŒëŒ ì„¤ì • ì €ì¥
                    </button>
                </div>
            </div>
            
            <!-- IoT ì¥ì¹˜ ì œì–´ -->
            <div class="card">
                <h2>IoT ì¥ì¹˜ ì œì–´</h2>
                
                <!-- ìë™/ìˆ˜ë™ ëª¨ë“œ ì „ì²´ ì œì–´ ìŠ¤ìœ„ì¹˜ ì¶” -->
                <div class="mode-switch-container">
                    <label class="switch">
                        <input type="checkbox" id="globalAutoMode" checked onchange="toggleGlobalMode()">
                        <span class="slider round"></span>
                    </label>
                    <span>ìë™ ì œì–´ ëª¨ë“œ</span>
                </div>
                
                <!-- ê¸°ì¡´ ì¥ì¹˜ ì œì–´ ë¶€ë¶„ -->
                <div class="device-controls">
                    <!-- LED ì œì–´ -->
                    <div class="device-control">
                        <h3>ì¡°ëª… ì œì–´</h3>
                        <div class="control-group">
                            <div class="led-control">
                                <label>í°ìƒ‰ LED</label>
                                <input type="range" id="whiteLED" min="0" max="100" value="0" 
                                    oninput="updateLED('white', this.value)">
                                <span id="whiteLEDValue">0%</span>
                            </div>
                            <div class="led-control">
                                <label>ë…¸ë€ìƒ‰ LED</label>
                                <input type="range" id="yellowLED" min="0" max="100" value="0" 
                                    oninput="updateLED('yellow', this.value)">
                                <span id="yellowLEDValue">0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- ì œìŠµê¸° ì œì–´ -->
                    <div class="device-control small-control">
                        <h3>ì œìŠµê¸°</h3>
                        <button id="dehumidifierBtn" class="btn" onclick="toggleDehumidifier()">
                            Off
                        </button>
                    </div>

                    <!-- ì„ í’ê¸° ì œì–´ -->
                    <div class="device-control small-control">
                        <h3>ì„ í’ê¸°</h3>
                        <button id="fanBtn" class="btn" onclick="toggleFan()">
                            On
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="second-row">
            <!-- ì‹¤ì‹œê°„ ìˆ˜ë©´ ë¶„ì„ ê·¸ë˜í”„ -->
            <div class="sleep-mode-components" style="display: none;">
                <div class="card">
                    <h2>ìˆ˜ë©´ ìƒíƒœ ë¶„ì„</h2>
                    <div class="chart-container">
                        <canvas id="sleepChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- CCTV í™”ë©´ -->
            <div class="card cctv-card">
                <h2>CCTV ëª¨ë‹ˆí„°ë§</h2>
                <div class="cctv-container">
                    <img id="cctvFeed" src="/video_feed" alt="CCTV í”¼ë“œ">
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-content">
            <p>Â© 2024 ìŠ¤ë§ˆíŠ¸ ìˆ˜ë©´ ê´€ë¦¬ ì‹œìŠ¤í…œ | ëª¨ë“  ê¶Œë¦¬ ë³´ìœ </p>
        </div>
    </footer>

    <!-- ì•ŒëŒ ëª¨ë‹¬ ì¶”ê°€ -->
    <div id="alarmModal" class="modal">
        <div class="modal-content">
            <h2>ì¢‹ì€ ì•„ì¹¨ì…ë‹ˆë‹¤! ğŸ˜Š</h2>
            <div id="sleepInfo">
                <p id="sleepDuration"></p>
                <div class="weather-info">
                    <h3>ì˜¤ëŠ˜ì˜ ì„œìš¸ ë‚ ì”¨</h3>
                    <div id="weatherInfo">
                        <p id="weatherDescription"></p>
                        <p id="currentTemp"></p>
                        <p id="currentHumidity"></p>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-primary" onclick="stopAlarm()">ì•ŒëŒ ë„ê¸°</button>
                <button class="btn btn-secondary" onclick="closeModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- MQTT ë¸Œë¡œì»¤ ì—°ê²° ì •ë³´ (ìˆ¨ê¹€ ì²˜ë¦¬) -->
    <div style="display: none;">
        <input id="broker" type="text" name="broker" value="">
        <div id="messages"></div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ ì„ ì–¸
        let sleepModeActive = false;
        let sleepStartTime = null;
        let timerInterval = null;
        let alarmTimeout = null;
        let alarmAudio = new Audio('/static/sounds/christmas.mp3');  // ê¸°ë³¸ ì•ŒëŒ ì†Œë¦¬ë¡œ ì´ˆê¸°í™”
        alarmAudio.load();  // ì˜¤ë””ì˜¤ ë¯¸ë¦¬ ë¡œë“œ
        let isAutoMode = true;  // ì „ ìë™/ìˆ˜ë™ ëª¨ë“œ ìƒíƒœ

        function toggleSleepMode() {
            const btn = document.getElementById('sleepModeBtn');
            const sleepComponents = document.querySelector('.sleep-mode-components');
            sleepModeActive = !sleepModeActive;
            
            if (sleepModeActive) {
                // ìˆ˜ë©´ ëª¨ë“œ í™œì„±í™”
                document.body.classList.add('sleep-mode');
                btn.textContent = "ìˆ˜ë©´ ëª¨ë“œ ë¹„í™œì„±í™”";
                sleepComponents.style.display = 'grid';
                
                // LED ë„ê¸°
                updateLED('white', 0);
                updateLED('yellow', 0);
                
                // LED ìŠ¬ë¼ì´ë” ê°’ë„ 0ìœ¼ë¡œ ì„¤ì •
                document.getElementById('whiteLED').value = 0;
                document.getElementById('yellowLED').value = 0;
                document.getElementById('whiteLEDValue').textContent = '0%';
                document.getElementById('yellowLEDValue').textContent = '0%';
                
                // íƒ€ì´ë¨¸ ì‹œì‘
                startTimer();
                startSleepMonitoring();
            } else {
                // ìˆ˜ë©´ ëª¨ë“œ ë¹„í™œì„±í™”
                document.body.classList.remove('sleep-mode');
                btn.textContent = "ìˆ˜ë©´ ëª¨ë“œ í™œì„±í™”";
                sleepComponents.style.display = 'none';
                stopSleepMonitoring();
                
                // íƒ€ì´ë¨¸ ì •ì§€
                stopTimer();
            }
        }

        function startTimer() {
            // ì´ì „ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì •ì§€
            stopTimer();
            
            // ì‹œì‘ ì‹œê°„ ì„¤ì •
            sleepStartTime = Date.now();
            
            // ì´ˆê¸°ê°’ í‘œì‹œ
            document.getElementById('sleepTimer').textContent = "00:00:00";
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            sleepStartTime = null;
        }

        function updateTimer() {
            if (!sleepStartTime) return;
            
            const currentTime = Date.now();
            const elapsedTime = currentTime - sleepStartTime;
            
            const hours = Math.floor(elapsedTime / 3600000);
            const minutes = Math.floor((elapsedTime % 3600000) / 60000);
            const seconds = Math.floor((elapsedTime % 60000) / 1000);
            
            const timeString = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('sleepTimer').textContent = timeString;
        }

        function startSleepMonitoring() {
            // í™˜ê²½ ëª¨ë‹ˆí„°ë§ ì‹œì‘
            setInterval(checkEnvironment, 5000);
        }

        function checkEnvironment() {
            const temp = parseFloat(document.getElementById('temperature').textContent);
            const humidity = parseFloat(document.getElementById('humidity').textContent);
            
            // ìë™ ëª¨ë“œì¼ ë•Œë§Œ í™˜ê²½ì— ë”°ë¥¸ ì œì–´ ì‹¤í–‰
            if (isAutoMode) {
                // ìŠµë„ì— ë”°ë¥¸ ì œìŠµê¸° ì œì–´ (60% ì´ìƒì¼ ë•Œ ì‘ë™)
                if (humidity >= 60) {
                    const dehumidifierBtn = document.getElementById('dehumidifierBtn');
                    if (dehumidifierBtn.textContent.includes('On')) {  // êº¼ì ¸ìˆì„ ë•Œ
                        toggleDehumidifier();  // ì¼œê¸°
                    }
                } else if (humidity < 55) {  // íˆìŠ¤í…Œë¦¬ì‹œìŠ¤ ì ìš©
                    const dehumidifierBtn = document.getElementById('dehumidifierBtn');
                    if (dehumidifierBtn.textContent.includes('Off')) {  // ì¼œì ¸ìˆì„ ë•Œ
                        toggleDehumidifier();  // ë„ê¸°
                    }
                }
                
                // ì˜¨ë„ì— ë”°ë¥¸ ì„ í’ê¸° ì œì–´ (ê¸°ì¡´ ì½”ë“œ ìœ ì§€)
                if (temp > 25) {
                    const fanBtn = document.getElementById('fanBtn');
                    if (fanBtn.textContent.includes('On')) {
                        toggleFan();
                    }
                } else if (temp <= 24) {
                    const fanBtn = document.getElementById('fanBtn');
                    if (fanBtn.textContent.includes('Off')) {
                        toggleFan();
                    }
                }
            }
        }

        window.addEventListener("load", drawChart);
        window.addEventListener("load", function () {
            const brokerInput = document.getElementById("broker");
            if (brokerInput) {
                brokerInput.value = "172.20.10.5";
                connect();  // MQTT ì—°ê²°ë§Œ ì‹œë„
            } else {
                console.error("Broker input element not found");
            }
        });

        // IoT ì¥ì¹˜ ì œì–´ í•¨ìˆ˜ë“¤
        function updateLED(color, value) {
            console.log(`LED ì œì–´ ì‹œë„: ${color}, ${value}`);
            if(!connectionFlag) {
                console.error('MQTT ì—°ê²° ì•ˆë¨');
                return;
            }
            publish(`led/${color}`, value);
        }

        function toggleDehumidifier() {
            const btn = document.getElementById('dehumidifierBtn');
            const currentState = btn.textContent.trim();
            
            if (currentState === 'On') {
                btn.textContent = 'Off';
                // MQTTë¡œ ê°€ìŠµê¸° ë„ê¸° ëª…ë ¹ ì „ì†¡
                publish('servo/humidifier', '0');
            } else {
                btn.textContent = 'On';
                // MQTTë¡œ ê°€ìŠµê¸° ì¼œê¸° ëª…ë ¹ ì „ì†¡
                publish('servo/humidifier', '1');
            }
            btn.classList.toggle('btn-primary');
        }

        function toggleFan() {
            const btn = document.getElementById('fanBtn');
            const isOn = btn.textContent.includes('Off');
            
            btn.textContent = isOn ? 'On' : 'Off';
            btn.classList.toggle('btn-primary');
            
            // MQTTë¡œ ì„ í’ê¸° ì œì–´ ë©”ì‹œì§€ ì „ì†¡
            publish('servo/fan', isOn ? '0' : '1');
        }

        function onMessageArrived(msg) {
            try {
                const value = parseFloat(msg.payloadString);
                if (isNaN(value)) {
                    console.error("ìœ íš¨í•˜ì§€ ì•Šì€ ê°’:", msg.payloadString);
                    return;
                }
                
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] ${msg.destinationName}: ${value}`);
                
                // HTML ìš”ì†Œ ë°ì´íŠ¸
                switch(msg.destinationName) {
                    case "temperature":
                        document.getElementById("temperature").textContent = value.toFixed(1) + "Â°C";
                        addChartData(0, value);
                        checkEnvironment(); // í™˜ê²½ ì²´í¬ ì¶”ê°€
                        break;
                    case "humidity":
                        document.getElementById("humidity").textContent = value.toFixed(1) + "%";
                        addChartData(1, value);
                        checkEnvironment(); // í™˜ê²½ í¬ ì¶”ê°€
                        break;
                    case "light":
                        document.getElementById("light").textContent = value.toFixed(1) + "%";
                        addChartData(2, value);
                        break;
                }
            } catch (e) {
                console.error("ë©”ì‹œì§€ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:", e);
            }
        }

        function startAlarmWithFan() {
            console.log('ì•ŒëŒ ì‹œì‘!');  // ë””ë²„ê¹…ìš© ë¡œê·¸
            
            // ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ ì „ ì¤€ë¹„
            alarmAudio.load();
            
            // ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ
            const playPromise = alarmAudio.play();
            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    console.log('ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ ì„±ê³µ');
                })
                .catch(error => {
                    console.error('ì•ŒëŒ ì†Œë¦¬ ì¬ìƒ ì‹¤íŒ¨:', error);
                });
            }
            
            document.getElementById('alarmModal').style.display = 'block';
            
            // ì„ í’ê¸° ì¼œê¸°
            publish('servo/fan', '1');
            
            // LED ë°ê¸° ì„œì„œíˆ ì¦ê°€ (10ì´ˆ ë™ì•ˆ)
            let brightness = 0;
            const brightInterval = setInterval(() => {
                if (brightness >= 100) {
                    clearInterval(brightInterval);
                    return;
                }
                brightness += 2;
                publish('led/white', brightness.toString());
                document.getElementById('whiteLED').value = brightness;
                document.getElementById('whiteLEDValue').textContent = brightness + '%';
            }, 200);
        }

        function saveAlarmSettings() {
            const wakeUpTime = document.getElementById('wakeUpTime').value;
            const alarmSound = document.getElementById('alarmSound').value;
            
            if (!wakeUpTime) {
                alert('ê¸°ìƒ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì´ì „ ì•ŒëŒ íƒ€ì´ë¨¸ê°€ ìˆë‹¤ë©´ ì œê±°
            if (alarmTimeout) {
                clearTimeout(alarmTimeout);
            }
            
            // ì•ŒëŒ ì†Œë¦¬ ì„¤ì •
            const soundFiles = {
                'christmas': '/static/sounds/christmas.mp3',
                'soft_calm': '/static/sounds/soft_calm.mp3',
                'summer_morning': '/static/sounds/summer_morning.mp3'
            };
            
            // ìƒˆë¡œìš´ ì•ŒëŒ ì†Œë¦¬ ì„¤ì • ë° ë¡œë“œ
            alarmAudio.src = soundFiles[alarmSound];
            alarmAudio.load();  // ìƒˆ ì†ŒìŠ¤ ë¡œë“œ
            alarmAudio.loop = true;
            
            const [hours, minutes] = wakeUpTime.split(':');
            const now = new Date();
            const alarmTime = new Date();
            alarmTime.setHours(parseInt(hours));
            alarmTime.setMinutes(parseInt(minutes));
            alarmTime.setSeconds(0);
            
            if (alarmTime < now) {
                alarmTime.setDate(alarmTime.getDate() + 1);
            }
            
            const timeUntilAlarm = alarmTime - now;
            console.log(`ì•ŒëŒì´ ${Math.floor(timeUntilAlarm / 1000 / 60)}ë¶„ í›„ì— ìš¸ë¦½ë‹ˆë‹¤.`);
            
            alarmTimeout = setTimeout(startAlarmWithFan, timeUntilAlarm);
            alert(`ì•ŒëŒì´ ${alarmTime.toLocaleTimeString()}ì— ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function stopAlarm() {
            // ì•ŒëŒ ì¤‘ì§€
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            
            // ì„ í’ê¸° ë„ê¸°
            client.publish('servo/fan', '0');
            
            // ìˆ˜ë©´ ì‹œê°„ ê³„ì‚°
            const endTime = new Date();
            const duration = endTime - sleepStartTime;
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('sleepDuration').textContent = 
                `ì´ ìˆ˜ë©´ ì‹œê°„: ${hours}ì‹œê°„ ${minutes}ë¶„`;
            
            // ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            const WEATHER_API_KEY = 'ì—¬ê¸°ì—_OpenWeatherMap_API_í‚¤_ì…ë ¥';
            fetch(
                `https://api.openweathermap.org/data/2.5/weather?q=Seoul&appid=${WEATHER_API_KEY}&units=metric&lang=kr`
            )
            .then(response => response.json())
            .then(data => {
                document.getElementById('weatherDescription').textContent = 
                    `ë‚ ì”¨: ${data.weather[0].description}`;
                document.getElementById('currentTemp').textContent = 
                    `í˜„ì¬ ê¸°ì˜¨: ${Math.round(data.main.temp)}Â°C`;
                document.getElementById('currentHumidity').textContent = 
                    `í˜„ì¬ ìŠµë„: ${data.main.humidity}%`;
            })
            .catch(error => {
                console.error('ë‚ ì”¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                // ë‚ ì”¨ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆì„ ë•Œ ê¸°ë³¸ê°’ ì„¤ì •
                document.getElementById('weatherDescription').textContent = 
                    'ë‚ ì”¨: ì¼êµì°¨ê°€ í¬ê³  ìŒ€ìŒ€í•œ ë‚ ì”¨ì…ë‹ˆë‹¤. ë”°ëœ»í•˜ê²Œ ì…ìœ¼ì„¸ìš”!';
                document.getElementById('currentTemp').textContent = 
                    'ê¸°ì˜¨: ìµœì € -2Â°C / ìµœê³  7Â°C';
                document.getElementById('currentHumidity').textContent = 
                    'í˜„ì¬ ìŠµë„: 45%';
            });
        }

        function closeModal() {
            // ì•ŒëŒ ì¤‘ì§€
            alarmAudio.pause();
            alarmAudio.currentTime = 0;
            
            // ì„ í’ê¸° ë„ê¸°
            publish('servo/fan', '0');
            
            // ëª¨ë‹¬ ë‹«ê¸°
            document.getElementById('alarmModal').style.display = 'none';
        }

        function toggleGlobalMode() {
            isAutoMode = document.getElementById('globalAutoMode').checked;
            console.log('ìë™ ëª¨ë“œ:', isAutoMode);
        }

        // LED ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('whiteLED').addEventListener('input', function() {
            const value = this.value;
            document.getElementById('whiteLEDValue').textContent = value + '%';
            updateLED('white', value);
        });

        document.getElementById('yellowLED').addEventListener('input', function() {
            const value = this.value;
            document.getElementById('yellowLEDValue').textContent = value + '%';
            updateLED('yellow', value);
        });
    </script>
</body>
</html>
